<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adamart - Dashboard Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'adamart': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: pulse 2s infinite;
        }
        .chart-bar {
            transition: all 0.3s ease;
        }
        .chart-bar:hover {
            transform: scaleY(1.1);
        }
        .search-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <!-- Header -->
    <header class="gradient-bg text-white p-4 sticky top-0 z-30">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold">üè™ Adamart Manager</h1>
                <p class="text-sm opacity-90">Dashboard Manajemen Toko</p>
            </div>
            <div class="flex items-center space-x-2">
                <div class="search-box rounded-lg px-3 py-2">
                    <input type="text" id="globalSearch" placeholder="Cari produk..." class="bg-transparent text-white placeholder-white placeholder-opacity-70 outline-none text-sm w-32 md:w-48">
                </div>
                <button onclick="refreshData()" class="bg-white bg-opacity-20 p-2 rounded-lg hover:bg-opacity-30 transition-all">
                    <span id="refreshIcon">üîÑ</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 space-y-6 pb-20">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-8">
            <div class="loading bg-adamart-500 w-16 h-16 rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat data dari Google Sheets...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden space-y-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">Total Pendapatan</p>
                            <p id="totalRevenue" class="text-2xl font-bold">Rp 0</p>
                            <p id="revenueGrowth" class="text-xs text-green-100">+0% dari kemarin</p>
                        </div>
                        <div class="text-3xl">üí∞</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Total Transaksi</p>
                            <p id="totalTransactions" class="text-2xl font-bold">0</p>
                            <p id="transactionGrowth" class="text-xs text-blue-100">+0 transaksi hari ini</p>
                        </div>
                        <div class="text-3xl">üìä</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm">Produk Terlaris</p>
                            <p id="topProduct" class="text-lg font-bold">-</p>
                            <p id="topProductSales" class="text-xs text-purple-100">0 terjual</p>
                        </div>
                        <div class="text-3xl">üèÜ</div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-red-400 to-red-600 text-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100 text-sm">Stok Menipis</p>
                            <p id="lowStockCount" class="text-2xl font-bold">0</p>
                            <p class="text-xs text-red-100">Produk < 10 stok</p>
                        </div>
                        <div class="text-3xl">‚ö†Ô∏è</div>
                    </div>
                </div>
            </div>

            <!-- Filter Area -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0">
                    <h3 class="text-lg font-semibold">üìç Filter Data</h3>
                    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-3">
                        <select id="areaFilter" onchange="applyFilters()" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500">
                            <option value="all">Semua Area</option>
                            <option value="adamart 73">Adamart 73</option>
                            <option value="adamart induksi">Adamart Induksi</option>
                            <option value="adamart kelanis">Adamart Kelanis</option>
                        </select>
                        <select id="dateFilter" onchange="applyFilters()" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500">
                            <option value="today">Hari Ini</option>
                            <option value="week">Minggu Ini</option>
                            <option value="month">Bulan Ini</option>
                            <option value="all">Semua Waktu</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sales Performance Chart -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <h3 class="text-lg font-semibold mb-4">üìà Performa Penjualan per Area</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-lg p-4">
                            <div class="text-2xl mb-2">üè¢</div>
                            <h4 class="font-semibold text-blue-800">Adamart 73</h4>
                            <div class="mt-2">
                                <div class="bg-blue-200 rounded-full h-4 mb-2">
                                    <div id="chart73" class="bg-blue-600 h-4 rounded-full chart-bar" style="width: 0%"></div>
                                </div>
                                <p id="sales73" class="text-sm text-blue-700">Rp 0</p>
                                <p id="transactions73" class="text-xs text-blue-600">0 transaksi</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="bg-green-100 rounded-lg p-4">
                            <div class="text-2xl mb-2">‚ö°</div>
                            <h4 class="font-semibold text-green-800">Adamart Induksi</h4>
                            <div class="mt-2">
                                <div class="bg-green-200 rounded-full h-4 mb-2">
                                    <div id="chartInduksi" class="bg-green-600 h-4 rounded-full chart-bar" style="width: 0%"></div>
                                </div>
                                <p id="salesInduksi" class="text-sm text-green-700">Rp 0</p>
                                <p id="transactionsInduksi" class="text-xs text-green-600">0 transaksi</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="bg-purple-100 rounded-lg p-4">
                            <div class="text-2xl mb-2">üåü</div>
                            <h4 class="font-semibold text-purple-800">Adamart Kelanis</h4>
                            <div class="mt-2">
                                <div class="bg-purple-200 rounded-full h-4 mb-2">
                                    <div id="chartKelanis" class="bg-purple-600 h-4 rounded-full chart-bar" style="width: 0%"></div>
                                </div>
                                <p id="salesKelanis" class="text-sm text-purple-700">Rp 0</p>
                                <p id="transactionsKelanis" class="text-xs text-purple-600">0 transaksi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Products per Area -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <h3 class="text-lg font-semibold mb-4">üèÜ Produk Terlaris per Area</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-3">üè¢ Adamart 73</h4>
                        <div id="topProducts73" class="space-y-2">
                            <p class="text-gray-500 text-sm">Tidak ada data</p>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 mb-3">‚ö° Adamart Induksi</h4>
                        <div id="topProductsInduksi" class="space-y-2">
                            <p class="text-gray-500 text-sm">Tidak ada data</p>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-purple-800 mb-3">üåü Adamart Kelanis</h4>
                        <div id="topProductsKelanis" class="space-y-2">
                            <p class="text-gray-500 text-sm">Tidak ada data</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Low Stock Alert -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <h3 class="text-lg font-semibold mb-4">‚ö†Ô∏è Peringatan Stok Menipis</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                        <h4 class="font-semibold text-red-800 mb-3">üè¢ Adamart 73</h4>
                        <div id="lowStock73" class="space-y-2 max-h-32 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Semua stok aman</p>
                        </div>
                    </div>
                    <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                        <h4 class="font-semibold text-red-800 mb-3">‚ö° Adamart Induksi</h4>
                        <div id="lowStockInduksi" class="space-y-2 max-h-32 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Semua stok aman</p>
                        </div>
                    </div>
                    <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                        <h4 class="font-semibold text-red-800 mb-3">üåü Adamart Kelanis</h4>
                        <div id="lowStockKelanis" class="space-y-2 max-h-32 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Semua stok aman</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riwayat Transaksi -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                    <h3 class="text-lg font-semibold">üìã Riwayat Transaksi</h3>
                    <div class="flex items-center space-x-2 mt-2 md:mt-0">
                        <input type="text" id="transactionSearch" placeholder="Cari transaksi..." class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-adamart-500">
                        <button onclick="exportTransactions()" class="bg-adamart-600 text-white px-4 py-2 rounded-lg hover:bg-adamart-700 transition-colors text-sm">
                            üìä Export
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Waktu</th>
                                <th class="p-3 text-left">Area</th>
                                <th class="p-3 text-left">Items</th>
                                <th class="p-3 text-left">Total</th>
                                <th class="p-3 text-left">Metode</th>
                                <th class="p-3 text-left">Detail</th>
                            </tr>
                        </thead>
                        <tbody id="transactionHistory">
                            <tr>
                                <td colspan="6" class="p-8 text-center text-gray-500">Tidak ada data transaksi</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <p class="text-sm text-gray-600">Menampilkan <span id="transactionCount">0</span> transaksi</p>
                    <div class="flex space-x-2">
                        <button onclick="loadMoreTransactions()" class="text-adamart-600 hover:text-adamart-700 text-sm">Muat Lebih Banyak</button>
                    </div>
                </div>
            </div>

            <!-- Manajemen Stok -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <h3 class="text-lg font-semibold mb-4">üì¶ Manajemen Stok</h3>
                
                <!-- Form Tambah Produk/Stok -->
                <div class="bg-adamart-50 p-4 rounded-lg mb-6">
                    <h4 class="font-medium mb-3">‚ûï Tambah Produk/Stok Baru</h4>
                    <form id="stockForm" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="barcode" class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                                <input type="text" id="barcode" placeholder="Masukkan barcode" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                            </div>
                            <div>
                                <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
                                <input type="text" id="productName" placeholder="Masukkan nama produk" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Harga</label>
                                <input type="number" id="price" placeholder="Harga jual" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                            </div>
                            <div>
                                <label for="targetArea" class="block text-sm font-medium text-gray-700 mb-1">Area Tujuan</label>
                                <select id="targetArea" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                                    <option value="">Pilih Area</option>
                                    <option value="adamart 73">Adamart 73</option>
                                    <option value="adamart induksi">Adamart Induksi</option>
                                    <option value="adamart kelanis">Adamart Kelanis</option>
                                </select>
                            </div>
                            <div>
                                <label for="stockAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Stok</label>
                                <input type="number" id="stockAmount" placeholder="Jumlah stok" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-adamart-500" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-adamart-600 text-white py-3 rounded-lg hover:bg-adamart-700 transition-colors font-medium">
                            üíæ Simpan Produk/Stok
                        </button>
                    </form>
                </div>

                <!-- Tabel Stok -->
                <div class="mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
                        <h4 class="font-medium">üìä Data Stok Produk</h4>
                        <input type="text" id="stockSearch" placeholder="Cari produk..." class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-adamart-500 mt-2 md:mt-0">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Produk</th>
                                <th class="p-3 text-left">Harga</th>
                                <th class="p-3 text-left">Adamart 73</th>
                                <th class="p-3 text-left">Adamart Induksi</th>
                                <th class="p-3 text-left">Adamart Kelanis</th>
                                <th class="p-3 text-left">Total Stok</th>
                                <th class="p-3 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="stockTable">
                            <tr>
                                <td colspan="7" class="p-8 text-center text-gray-500">Tidak ada data stok</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Laporan Barang Rusak/Expired -->
            <div class="bg-white rounded-xl p-4 card-shadow">
                <h3 class="text-lg font-semibold mb-4">‚ö†Ô∏è Laporan Barang Rusak/Expired</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Waktu</th>
                                <th class="p-3 text-left">Produk</th>
                                <th class="p-3 text-left">Jumlah</th>
                                <th class="p-3 text-left">Keterangan</th>
                                <th class="p-3 text-left">Area</th>
                                <th class="p-3 text-left">Nilai Kerugian</th>
                            </tr>
                        </thead>
                        <tbody id="damageReports">
                            <tr>
                                <td colspan="6" class="p-8 text-center text-gray-500">Tidak ada laporan</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztGJnMLgclP0ji0VnqXgI3M9nCHq2_6CU57xUQLCJmomCCqCj85I8YxcZJAMYnuE3wpA/exec';
        
        let allData = {
            products: [],
            sales: [],
            reports: []
        };

        let filteredData = {
            sales: [],
            products: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadManagerData();
            setupStockForm();
            setupSearchFunctionality();
        });

        async function loadManagerData() {
            try {
                showLoading(true);
                
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_manager_data`);
                const data = await response.json();
                
                if (data.success) {
                    allData = data;
                    applyFilters(); // Apply initial filters
                } else {
                    throw new Error(data.error || 'Failed to load data');
                }
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Gagal memuat data dari server. Memuat data demo.');
                loadDemoData();
                showLoading(false);
            }
        }

        function loadDemoData() {
            allData = {
                products: [
                    {barcode: '001', name: 'Indomie Goreng', price: 3500, stock_73: 50, stock_induksi: 30, stock_kelanis: 25},
                    {barcode: '002', name: 'Aqua 600ml', price: 3000, stock_73: 8, stock_induksi: 35, stock_kelanis: 20},
                    {barcode: '003', name: 'Teh Botol Sosro', price: 4500, stock_73: 25, stock_induksi: 5, stock_kelanis: 15},
                ],
                sales: [
                    {timestamp: new Date().toISOString(), area: 'adamart 73', total: 15000, method: 'Tunai', items: 'Indomie Goreng x2, Aqua 600ml x3'},
                    {timestamp: new Date(Date.now() - 86400000).toISOString(), area: 'adamart induksi', total: 9000, method: 'QRIS', items: 'Teh Botol Sosro x2'},
                ],
                reports: [
                    {timestamp: new Date().toISOString(), barcode: '001', name: 'Indomie Goreng', quantity: 2, reason: 'Expired', area: 'adamart 73'},
                ]
            };
            
            applyFilters();
        }

        function applyFilters() {
            const selectedArea = document.getElementById('areaFilter').value;
            const selectedDate = document.getElementById('dateFilter').value;
            const now = new Date();
            let startDate;

            switch(selectedDate) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                default: // 'all'
                    startDate = new Date(0); // The beginning of time
                    break;
            }

            let tempSales = allData.sales.filter(sale => new Date(sale.timestamp) >= startDate);

            if (selectedArea !== 'all') {
                tempSales = tempSales.filter(sale => sale.area === selectedArea);
            }
            
            filteredData.sales = tempSales;
            updateDashboard();
        }


        function updateDashboard() {
            updateSummaryCards();
            updateSalesChart();
            updateTopProducts();
            updateLowStockAlerts();
            updateTransactionHistory();
            updateStockTable();
            updateDamageReports();
        }

        function updateSummaryCards() {
            const totalRevenue = filteredData.sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactions = filteredData.sales.length;
            
            const productSales = {};
            filteredData.sales.forEach(sale => {
                sale.items.split(',').forEach(itemDetail => {
                    const parts = itemDetail.split('x');
                    if(parts.length === 2) {
                        const name = parts[0].trim();
                        const qty = parseInt(parts[1].trim());
                        productSales[name] = (productSales[name] || 0) + qty;
                    }
                });
            });
            
            const topProduct = Object.keys(productSales).reduce((a, b) => 
                productSales[a] > productSales[b] ? a : b, '-'
            );

            const lowStockCount = allData.products.filter(product => 
                product.stock_73 < 10 || product.stock_induksi < 10 || product.stock_kelanis < 10
            ).length;

            document.getElementById('totalRevenue').textContent = `Rp ${totalRevenue.toLocaleString('id-ID')}`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('topProduct').textContent = topProduct;
            document.getElementById('topProductSales').textContent = `${productSales[topProduct] || 0} terjual`;
            document.getElementById('lowStockCount').textContent = lowStockCount;
        }

        function updateSalesChart() {
            const areaSales = {'adamart 73': 0, 'adamart induksi': 0, 'adamart kelanis': 0};
            const areaTransactions = {'adamart 73': 0, 'adamart induksi': 0, 'adamart kelanis': 0};

            filteredData.sales.forEach(sale => {
                if(areaSales[sale.area] !== undefined) {
                    areaSales[sale.area] += sale.total;
                    areaTransactions[sale.area]++;
                }
            });

            const maxSales = Math.max(1, ...Object.values(areaSales));

            document.getElementById('chart73').style.width = `${(areaSales['adamart 73'] / maxSales) * 100}%`;
            document.getElementById('chartInduksi').style.width = `${(areaSales['adamart induksi'] / maxSales) * 100}%`;
            document.getElementById('chartKelanis').style.width = `${(areaSales['adamart kelanis'] / maxSales) * 100}%`;

            document.getElementById('sales73').textContent = `Rp ${areaSales['adamart 73'].toLocaleString('id-ID')}`;
            document.getElementById('salesInduksi').textContent = `Rp ${areaSales['adamart induksi'].toLocaleString('id-ID')}`;
            document.getElementById('salesKelanis').textContent = `Rp ${areaSales['adamart kelanis'].toLocaleString('id-ID')}`;

            document.getElementById('transactions73').textContent = `${areaTransactions['adamart 73']} transaksi`;
            document.getElementById('transactionsInduksi').textContent = `${areaTransactions['adamart induksi']} transaksi`;
            document.getElementById('transactionsKelanis').textContent = `${areaTransactions['adamart kelanis']} transaksi`;
        }
        
        function updateTopProducts() {
            const areas = ['adamart 73', 'adamart induksi', 'adamart kelanis'];
            areas.forEach(area => {
                const productSales = {};
                filteredData.sales.filter(s => s.area === area).forEach(sale => {
                    sale.items.split(',').forEach(itemDetail => {
                        const parts = itemDetail.split('x');
                        if(parts.length === 2) {
                            const name = parts[0].trim();
                            const qty = parseInt(parts[1].trim());
                            productSales[name] = (productSales[name] || 0) + qty;
                        }
                    });
                });
                
                const sortedProducts = Object.entries(productSales)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3);
                
                const containerId = `topProducts${area.split(' ')[1].charAt(0).toUpperCase() + area.split(' ')[1].slice(1)}`;
                const container = document.getElementById(containerId);

                if (sortedProducts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Tidak ada data</p>';
                } else {
                    container.innerHTML = sortedProducts.map(([product, quantity], index) => `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-bold">${index + 1}</span>
                                <span class="text-sm">${product}</span>
                            </div>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">${quantity}</span>
                        </div>
                    `).join('');
                }
            });
        }


        function updateLowStockAlerts() {
            const areas = {
                'adamart 73': 'lowStock73',
                'adamart induksi': 'lowStockInduksi',
                'adamart kelanis': 'lowStockKelanis'
            };
            
            Object.keys(areas).forEach(area => {
                const stockField = `stock_${area.split(' ')[1]}`;
                const lowStockProducts = allData.products.filter(p => p[stockField] < 10 && p[stockField] > 0).slice(0, 5);
                const container = document.getElementById(areas[area]);

                if (lowStockProducts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Semua stok aman</p>';
                } else {
                    container.innerHTML = lowStockProducts.map(product => `
                        <div class="flex items-center justify-between bg-white p-2 rounded border-l-4 border-red-500">
                            <span class="text-sm font-medium">${product.name}</span>
                            <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">${product[stockField]} tersisa</span>
                        </div>
                    `).join('');
                }
            });
        }

        function updateTransactionHistory() {
            const tbody = document.getElementById('transactionHistory');
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
            
            let displaySales = filteredData.sales.filter(sale => 
                Object.values(sale).join(' ').toLowerCase().includes(searchTerm)
            );
            
            if (displaySales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">Tidak ada data transaksi</td></tr>';
                document.getElementById('transactionCount').textContent = '0';
                return;
            }

            tbody.innerHTML = displaySales.slice(0, 20).map(sale => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">
                        <div class="text-sm">${new Date(sale.timestamp).toLocaleDateString('id-ID')}</div>
                        <div class="text-xs text-gray-500">${new Date(sale.timestamp).toLocaleTimeString('id-ID')}</div>
                    </td>
                    <td class="p-3"><span class="px-2 py-1 bg-adamart-100 text-adamart-800 rounded text-xs">${sale.area}</span></td>
                    <td class="p-3"><div class="text-sm max-w-xs truncate" title="${sale.items}">${sale.items}</div></td>
                    <td class="p-3 font-medium">Rp ${sale.total.toLocaleString('id-ID')}</td>
                    <td class="p-3"><span class="px-2 py-1 ${getPaymentMethodColor(sale.method)} rounded text-xs">${sale.method}</span></td>
                    <td class="p-3"><button onclick="showTransactionDetail('${sale.timestamp}')" class="text-adamart-600 hover:text-adamart-700 text-xs">üëÅÔ∏è Detail</button></td>
                </tr>
            `).join('');

            document.getElementById('transactionCount').textContent = displaySales.length;
        }

        function getPaymentMethodColor(method) {
            switch(method) {
                case 'Tunai': return 'bg-green-100 text-green-800';
                case 'QRIS': return 'bg-blue-100 text-blue-800';
                case 'Kasbon': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function updateStockTable() {
            const tbody = document.getElementById('stockTable');
            const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
            
            let displayProducts = allData.products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.barcode.toLowerCase().includes(searchTerm)
            );
            
            if (displayProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500">Tidak ada data stok</td></tr>';
                return;
            }

            tbody.innerHTML = displayProducts.map(product => {
                const totalStock = product.stock_73 + product.stock_induksi + product.stock_kelanis;
                const isLowStock = product.stock_73 < 10 || product.stock_induksi < 10 || product.stock_kelanis < 10;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3"><div class="font-medium">${product.name}</div><div class="text-xs text-gray-500">${product.barcode}</div></td>
                        <td class="p-3 font-medium">Rp ${product.price.toLocaleString('id-ID')}</td>
                        <td class="p-3"><span class="px-2 py-1 ${getStockColor(product.stock_73)} rounded text-xs">${product.stock_73}</span></td>
                        <td class="p-3"><span class="px-2 py-1 ${getStockColor(product.stock_induksi)} rounded text-xs">${product.stock_induksi}</span></td>
                        <td class="p-3"><span class="px-2 py-1 ${getStockColor(product.stock_kelanis)} rounded text-xs">${product.stock_kelanis}</span></td>
                        <td class="p-3 font-medium">${totalStock}</td>
                        <td class="p-3"><span class="px-2 py-1 ${isLowStock ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'} rounded text-xs">${isLowStock ? '‚ö†Ô∏è Menipis' : '‚úÖ Aman'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function getStockColor(stock) {
            if (stock > 20) return 'bg-green-100 text-green-800';
            if (stock > 10) return 'bg-yellow-100 text-yellow-800';
            if (stock > 0) return 'bg-orange-100 text-orange-800';
            return 'bg-red-100 text-red-800';
        }

        function updateDamageReports() {
            const tbody = document.getElementById('damageReports');
            
            if (!allData.reports || allData.reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">Tidak ada laporan</td></tr>';
                return;
            }

            tbody.innerHTML = allData.reports.map(report => {
                const product = allData.products.find(p => p.barcode === report.barcode);
                const lossValue = product ? product.price * report.quantity : 0;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3"><div class="text-sm">${new Date(report.timestamp).toLocaleDateString('id-ID')}</div><div class="text-xs text-gray-500">${new Date(report.timestamp).toLocaleTimeString('id-ID')}</div></td>
                        <td class="p-3"><div class="font-medium">${report.name}</div><div class="text-xs text-gray-500">${report.barcode}</div></td>
                        <td class="p-3">${report.quantity}</td>
                        <td class="p-3"><span class="px-2 py-1 ${report.reason === 'Expired' ? 'bg-orange-100 text-orange-800' : 'bg-red-100 text-red-800'} rounded text-xs">${report.reason}</span></td>
                        <td class="p-3"><span class="px-2 py-1 bg-adamart-100 text-adamart-800 rounded text-xs">${report.area}</span></td>
                        <td class="p-3 font-medium text-red-600">Rp ${lossValue.toLocaleString('id-ID')}</td>
                    </tr>
                `;
            }).join('');
        }

        function setupStockForm() {
            document.getElementById('stockForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    barcode: document.getElementById('barcode').value,
                    name: document.getElementById('productName').value,
                    price: parseInt(document.getElementById('price').value),
                    area: document.getElementById('targetArea').value,
                    quantity: parseInt(document.getElementById('stockAmount').value)
                };

                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({action: 'update_stock', data: formData})
                    });
                    
                    alert('‚úÖ Stok berhasil diupdate! Data akan diperbarui.');
                    this.reset();
                    loadManagerData();

                } catch (error) {
                    console.error('Error updating stock:', error);
                    alert('‚ùå Gagal mengupdate stok. Silakan coba lagi.');
                }
            });
        }

        function setupSearchFunctionality() {
            document.getElementById('globalSearch').addEventListener('input', updateStockTable);
            document.getElementById('transactionSearch').addEventListener('input', updateTransactionHistory);
            document.getElementById('stockSearch').addEventListener('input', updateStockTable);
        }

        function showTransactionDetail(timestamp) {
            const transaction = allData.sales.find(sale => sale.timestamp === timestamp);
            if (transaction) {
                alert(`Detail Transaksi:\n\nWaktu: ${new Date(transaction.timestamp).toLocaleString('id-ID')}\nArea: ${transaction.area}\nItems: ${transaction.items}\nTotal: Rp ${transaction.total.toLocaleString('id-ID')}\nMetode: ${transaction.method}`);
            }
        }

        function exportTransactions() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Waktu,Area,Items,Total,Metode\n"
                + filteredData.sales.map(sale => 
                    `"${new Date(sale.timestamp).toLocaleString('id-ID')}","${sale.area}","${sale.items.replace(/"/g, '""')}","${sale.total}","${sale.method}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `adamart_transactions_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadMoreTransactions() {
            alert('Fitur ini akan diimplementasikan di masa mendatang.');
        }

        function refreshData() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('animate-spin');
            
            loadManagerData().finally(() => {
                setTimeout(() => icon.classList.remove('animate-spin'), 500);
            });
        }

        function showLoading(show) {
            document.getElementById('loadingState').classList.toggle('hidden', !show);
            document.getElementById('dashboardContent').classList.toggle('hidden', show);
        }
    </script>
</body>
</html>
