<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adamart - Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'adamart': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading {
            animation: pulse 2s infinite;
        }
        .chart-bar {
            transition: all 0.5s ease-out;
        }
        .chart-bar:hover {
            opacity: 0.8;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white p-4 sticky top-0 z-30">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold">üè™ Adamart Manager</h1>
                <p class="text-sm opacity-90">Dashboard Manajemen Toko</p>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="refreshData()" class="bg-white bg-opacity-20 p-2 rounded-lg hover:bg-opacity-30 transition-all">
                    <span id="refreshIcon">üîÑ</span>
                </button>
                <div class="text-right text-xs">
                    <div id="lastUpdate" class="opacity-75">Loading...</div>
                    <div id="connectionStatus" class="text-green-300">üü¢ Online</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 space-y-6 pb-20">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading bg-adamart-500 w-16 h-16 rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">Memuat data dari Google Sheets...</p>
            <p class="text-gray-500 text-sm mt-2">Mohon tunggu sebentar</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Gagal Memuat Data</h3>
            <p class="text-gray-600 mb-4">Tidak dapat terhubung ke Google Sheets</p>
            <button onclick="refreshData()" class="bg-adamart-600 text-white px-6 py-3 rounded-lg hover:bg-adamart-700 transition-all">
                üîÑ Coba Lagi
            </button>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden space-y-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">Total Pendapatan</p>
                            <p id="totalRevenue" class="text-2xl font-bold">Rp 0</p>
                            <p id="revenueGrowth" class="text-xs text-green-100">Berdasarkan filter</p>
                        </div>
                        <div class="text-4xl">üí∞</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Total Transaksi</p>
                            <p id="totalTransactions" class="text-2xl font-bold">0</p>
                             <p id="transactionGrowth" class="text-xs text-blue-100">Berdasarkan filter</p>
                        </div>
                        <div class="text-4xl">üìä</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm">Produk Terlaris</p>
                            <p id="topProduct" class="text-lg font-bold">-</p>
                            <p id="topProductSales" class="text-xs text-purple-100">0 terjual</p>
                        </div>
                        <div class="text-4xl">üèÜ</div>
                    </div>
                </div>
            </div>

            <!-- Filter Area -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-3 md:space-y-0">
                    <h3 class="text-lg font-semibold flex items-center">
                        <span class="mr-2">üìç</span>
                        Filter Data Penjualan
                    </h3>
                    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-3">
                        <select id="areaFilter" onchange="applyFilters()" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 bg-white">
                            <option value="all">Semua Area</option>
                            <option value="adamart 73">Adamart 73</option>
                            <option value="adamart induksi">Adamart Induksi</option>
                            <option value="adamart kelanis">Adamart Kelanis</option>
                        </select>
                        <select id="dateFilter" onchange="applyFilters()" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 bg-white">
                            <option value="today">Hari Ini</option>
                            <option value="week">7 Hari Terakhir</option>
                            <option value="month">Bulan Ini</option>
                            <option value="all">Semua Waktu</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sales Performance Chart -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">üìà</span>
                    Performa Penjualan per Area
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="bg-blue-100 rounded-lg p-4 hover:bg-blue-200 transition-all">
                            <div class="text-3xl mb-2">üè¢</div>
                            <h4 class="font-semibold text-blue-800">Adamart 73</h4>
                            <div class="mt-3">
                                <div class="bg-blue-200 rounded-full h-4 mb-2">
                                    <div id="chart73" class="bg-blue-600 h-4 rounded-full chart-bar" style="width: 0%"></div>
                                </div>
                                <p id="sales73" class="text-sm text-blue-700 font-medium">Rp 0</p>
                                <p id="transactions73" class="text-xs text-blue-600">0 transaksi</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="bg-green-100 rounded-lg p-4 hover:bg-green-200 transition-all">
                            <div class="text-3xl mb-2">‚ö°</div>
                            <h4 class="font-semibold text-green-800">Adamart Induksi</h4>
                            <div class="mt-3">
                                <div class="bg-green-200 rounded-full h-4 mb-2">
                                    <div id="chartInduksi" class="bg-green-600 h-4 rounded-full chart-bar" style="width: 0%"></div>
                                </div>
                                <p id="salesInduksi" class="text-sm text-green-700 font-medium">Rp 0</p>
                                <p id="transactionsInduksi" class="text-xs text-green-600">0 transaksi</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="bg-purple-100 rounded-lg p-4 hover:bg-purple-200 transition-all">
                            <div class="text-3xl mb-2">üåü</div>
                            <h4 class="font-semibold text-purple-800">Adamart Kelanis</h4>
                            <div class="mt-3">
                                <div class="bg-purple-200 rounded-full h-4 mb-2">
                                    <div id="chartKelanis" class="bg-purple-600 h-4 rounded-full chart-bar" style="width: 0%"></div>
                                </div>
                                <p id="salesKelanis" class="text-sm text-purple-700 font-medium">Rp 0</p>
                                <p id="transactionsKelanis" class="text-xs text-purple-600">0 transaksi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Products per Area -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">üèÜ</span>
                    Produk Terlaris per Area (berdasarkan filter)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                            <span class="mr-2">üè¢</span>
                            Adamart 73
                        </h4>
                        <div id="topProducts73" class="space-y-2">
                            <p class="text-gray-500 text-sm">Memuat data...</p>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4 bg-green-50">
                        <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                            <span class="mr-2">‚ö°</span>
                            Adamart Induksi
                        </h4>
                        <div id="topProductsInduksi" class="space-y-2">
                            <p class="text-gray-500 text-sm">Memuat data...</p>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4 bg-purple-50">
                        <h4 class="font-semibold text-purple-800 mb-3 flex items-center">
                            <span class="mr-2">üåü</span>
                            Adamart Kelanis
                        </h4>
                        <div id="topProductsKelanis" class="space-y-2">
                            <p class="text-gray-500 text-sm">Memuat data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Low Stock Alert -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">‚ö†Ô∏è</span>
                    Produk Stok Menipis (&lt; 10)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                        <h4 class="font-semibold text-red-800 mb-3 flex items-center">
                            <span class="mr-2">üè¢</span>
                            Adamart 73
                        </h4>
                        <div id="lowStock73" class="space-y-2 max-h-40 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Memuat data...</p>
                        </div>
                    </div>
                    <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                        <h4 class="font-semibold text-red-800 mb-3 flex items-center">
                            <span class="mr-2">‚ö°</span>
                            Adamart Induksi
                        </h4>
                        <div id="lowStockInduksi" class="space-y-2 max-h-40 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Memuat data...</p>
                        </div>
                    </div>
                    <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                        <h4 class="font-semibold text-red-800 mb-3 flex items-center">
                            <span class="mr-2">üåü</span>
                            Adamart Kelanis
                        </h4>
                        <div id="lowStockKelanis" class="space-y-2 max-h-40 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Memuat data...</p>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- Manajemen Stok -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">üì¶</span>
                    Manajemen Stok
                </h3>
                
                <!-- Form Tambah Produk/Stok -->
                <div class="bg-gradient-to-r from-adamart-50 to-blue-50 p-4 rounded-lg mb-6 border border-adamart-200">
                    <h4 class="font-medium mb-3 flex items-center text-adamart-800">
                        <span class="mr-2">‚ûï</span>
                        Tambah Produk/Stok Baru
                    </h4>
                    <form id="stockForm" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="barcode" class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                                <input type="text" id="barcode" placeholder="Masukkan barcode" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 focus:border-adamart-500" required>
                            </div>
                            <div>
                                <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
                                <input type="text" id="productName" placeholder="Masukkan nama produk" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 focus:border-adamart-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Harga</label>
                                <input type="number" id="price" placeholder="Harga jual" min="0" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 focus:border-adamart-500" required>
                            </div>
                            <div>
                                <label for="targetArea" class="block text-sm font-medium text-gray-700 mb-1">Area Tujuan</label>
                                <select id="targetArea" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 focus:border-adamart-500 bg-white" required>
                                    <option value="">Pilih Area</option>
                                    <option value="adamart 73">Adamart 73</option>
                                    <option value="adamart induksi">Adamart Induksi</option>
                                    <option value="adamart kelanis">Adamart Kelanis</option>
                                </select>
                            </div>
                            <div>
                                <label for="stockAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Stok</label>
                                <input type="number" id="stockAmount" placeholder="Jumlah stok" min="1" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-adamart-500 focus:border-adamart-500" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-adamart-600 text-white py-3 rounded-lg hover:bg-adamart-700 transition-colors font-medium">
                            üíæ Simpan Produk/Stok
                        </button>
                    </form>
                </div>

                <!-- Tabel Stok -->
                <div class="mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
                        <h4 class="font-medium flex items-center">
                            <span class="mr-2">üìä</span>
                            Data Stok Produk
                        </h4>
                        <input type="text" id="stockSearch" placeholder="Cari produk..." 
                               class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-adamart-500 mt-2 md:mt-0 w-full md:w-48">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left font-medium text-gray-700">Produk</th>
                                <th class="p-3 text-left font-medium text-gray-700">Harga</th>
                                <th class="p-3 text-left font-medium text-gray-700">Adamart 73</th>
                                <th class="p-3 text-left font-medium text-gray-700">Adamart Induksi</th>
                                <th class="p-3 text-left font-medium text-gray-700">Adamart Kelanis</th>
                                <th class="p-3 text-left font-medium text-gray-700">Total Stok</th>
                                <th class="p-3 text-left font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="stockTable">
                            <tr>
                                <td colspan="7" class="p-8 text-center text-gray-500">Memuat data stok...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Riwayat Transaksi -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center">
                        <span class="mr-2">üìã</span>
                        Riwayat Transaksi
                    </h3>
                    <div class="flex items-center space-x-2 mt-2 md:mt-0">
                        <input type="text" id="transactionSearch" placeholder="Cari transaksi..." 
                               class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-adamart-500 w-full md:w-48">
                        <button onclick="exportTransactions()" class="bg-adamart-600 text-white px-4 py-2 rounded-lg hover:bg-adamart-700 transition-colors text-sm whitespace-nowrap">
                            üìä Export
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left font-medium text-gray-700">Waktu</th>
                                <th class="p-3 text-left font-medium text-gray-700">Area</th>
                                <th class="p-3 text-left font-medium text-gray-700">Items</th>
                                <th class="p-3 text-left font-medium text-gray-700">Total</th>
                                <th class="p-3 text-left font-medium text-gray-700">Metode</th>
                            </tr>
                        </thead>
                        <tbody id="transactionHistory">
                            <tr>
                                <td colspan="5" class="p-8 text-center text-gray-500">Memuat data transaksi...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <div class="flex justify-between items-center mt-4">
                    <p class="text-sm text-gray-600">Menampilkan <span id="transactionCount">0</span> dari <span id="totalTransactionCount">0</span> transaksi</p>
                    <div id="paginationControls" class="flex items-center space-x-2">
                         <!-- Pagination buttons will be added here -->
                    </div>
                </div>
            </div>

            <!-- Laporan Barang Rusak/Expired -->
            <div class="bg-white rounded-xl p-4 card-shadow slide-up">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="mr-2">‚ö†Ô∏è</span>
                    Laporan Barang Rusak/Expired
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left font-medium text-gray-700">Waktu</th>
                                <th class="p-3 text-left font-medium text-gray-700">Produk</th>
                                <th class="p-3 text-left font-medium text-gray-700">Jumlah</th>
                                <th class="p-3 text-left font-medium text-gray-700">Keterangan</th>
                                <th class="p-3 text-left font-medium text-gray-700">Area</th>
                                <th class="p-3 text-left font-medium text-gray-700">Nilai Kerugian</th>
                            </tr>
                        </thead>
                        <tbody id="damageReports">
                            <tr>
                                <td colspan="6" class="p-8 text-center text-gray-500">Memuat laporan...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed top-4 right-4 z-50 bg-green-500 text-white p-4 rounded-lg shadow-lg bounce-in">
        <div class="flex items-center space-x-2">
            <span class="text-xl">‚úÖ</span>
            <span id="successMessage">Berhasil!</span>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="hidden fixed top-4 right-4 z-50 bg-red-500 text-white p-4 rounded-lg shadow-lg bounce-in">
        <div class="flex items-center space-x-2">
            <span class="text-xl">‚ùå</span>
            <span id="errorMessage">Terjadi kesalahan!</span>
        </div>
    </div>

    <script>
        // Configuration - URL Google Apps Script Adamart
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztGJnMLgclP0ji0VnqXgI3M9nCHq2_6CU57xUQLCJmomCCqCj85I8YxcZJAMYnuE3wpA/exec';
        
        let allData = { products: [], sales: [], reports: [] };
        let filteredSales = [];
        
        const TRANSACTIONS_PER_PAGE = 20;
        let currentPage = 1;

        document.addEventListener('DOMContentLoaded', function() {
            loadManagerData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('stockForm').addEventListener('submit', handleStockFormSubmit);
            document.getElementById('transactionSearch').addEventListener('input', () => { currentPage = 1; applyFilters(); });
            document.getElementById('stockSearch').addEventListener('input', updateStockTable);
            // Menambahkan listener untuk auto-fill data produk
            document.getElementById('barcode').addEventListener('input', autoFillProductDetails);
        }

        // Fungsi baru untuk auto-fill form produk
        function autoFillProductDetails() {
            const barcode = document.getElementById('barcode').value.trim();
            const productNameInput = document.getElementById('productName');
            const priceInput = document.getElementById('price');

            if (!barcode) {
                return; // Jangan lakukan apa-apa jika kosong
            }

            // Cari produk di master list (allData.products)
            // Gunakan String() untuk perbandingan aman (jika barcode dari sheet adalah angka)
            const product = allData.products.find(p => String(p.Barcode) === barcode);

            if (product) {
                // Jika produk ditemukan, isi kolom nama dan harga
                productNameInput.value = product['Nama Produk'];
                priceInput.value = product['Harga'];
            }
            // Jika tidak ditemukan, biarkan pengguna mengisinya secara manual (untuk produk baru)
            // Kita tidak mengosongkan field jika tidak ketemu, agar pengguna bisa edit manual
        }

        async function loadManagerData() {
            try {
                showLoading(true);
                updateConnectionStatus('connecting');
                
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_manager_data`);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.success) {
                    allData = data.data;
                    allData.sales.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort sales descending
                    applyFilters();
                    updateConnectionStatus('online');
                    updateLastUpdate();
                    showLoading(false);
                } else {
                    throw new Error(data.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                updateConnectionStatus('offline');
                showError('Gagal memuat data. Periksa koneksi dan URL Apps Script.');
                showLoading(false, true);
            }
        }
        
        function applyFilters() {
            const area = document.getElementById('areaFilter').value;
            const date = document.getElementById('dateFilter').value;
            const search = document.getElementById('transactionSearch').value.toLowerCase();
            
            let sales = allData.sales;

            // Filter by area
            if (area !== 'all') {
                sales = sales.filter(s => s.area === area);
            }

            // Filter by date
            const now = new Date();
            let startDate;
            switch(date) {
                case 'today': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                case 'week': startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
            }
            if (startDate) {
                sales = sales.filter(s => s.timestamp && new Date(s.timestamp) >= startDate);
            }

            // Filter by search term
            if (search) {
                sales = sales.filter(s =>
                    (s.items && s.items.toLowerCase().includes(search)) ||
                    (s.area && s.area.toLowerCase().includes(search)) ||
                    (s.method && s.method.toLowerCase().includes(search))
                );
            }
            
            filteredSales = sales;
            currentPage = 1; // Reset to first page on filter change
            updateDashboard();
        }

        function updateDashboard() {
            updateSummaryCards();
            updateSalesChart();
            updateTopProducts();
            updateLowStockAlerts();
            updateTransactionHistory();
            updateStockTable();
            updateDamageReports();
        }

        function updateSummaryCards() {
            const totalRevenue = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const totalTransactions = filteredSales.length;

            const productSales = {};
            filteredSales.forEach(sale => {
                if (sale.items) {
                    const items = sale.items.split(',');
                    items.forEach(item => {
                        const match = item.trim().match(/^(.+?)\s+x(\d+)$/);
                        if (match) {
                            const productName = match[1].trim();
                            const quantity = parseInt(match[2]);
                            productSales[productName] = (productSales[productName] || 0) + quantity;
                        }
                    });
                }
            });
            
            const topProduct = Object.keys(productSales).length > 0 ? 
                Object.keys(productSales).reduce((a, b) => productSales[a] > productSales[b] ? a : b) : '-';

            document.getElementById('totalRevenue').textContent = `Rp ${totalRevenue.toLocaleString('id-ID')}`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('topProduct').textContent = topProduct;
            document.getElementById('topProductSales').textContent = `${productSales[topProduct] || 0} terjual`;
        }

        function updateSalesChart() {
            const salesByArea = { 'adamart 73': 0, 'adamart induksi': 0, 'adamart kelanis': 0 };
            const transByArea = { 'adamart 73': 0, 'adamart induksi': 0, 'adamart kelanis': 0 };
            
            filteredSales.forEach(sale => {
                if (sale.area && sale.total) {
                    salesByArea[sale.area] = (salesByArea[sale.area] || 0) + sale.total;
                    transByArea[sale.area] = (transByArea[sale.area] || 0) + 1;
                }
            });

            const maxSales = Math.max(1, ...Object.values(salesByArea));

            document.getElementById('chart73').style.width = `${(salesByArea['adamart 73'] / maxSales) * 100}%`;
            document.getElementById('sales73').textContent = `Rp ${salesByArea['adamart 73'].toLocaleString('id-ID')}`;
            document.getElementById('transactions73').textContent = `${transByArea['adamart 73']} transaksi`;
            
            document.getElementById('chartInduksi').style.width = `${(salesByArea['adamart induksi'] / maxSales) * 100}%`;
            document.getElementById('salesInduksi').textContent = `Rp ${salesByArea['adamart induksi'].toLocaleString('id-ID')}`;
            document.getElementById('transactionsInduksi').textContent = `${transByArea['adamart induksi']} transaksi`;
            
            document.getElementById('chartKelanis').style.width = `${(salesByArea['adamart kelanis'] / maxSales) * 100}%`;
            document.getElementById('salesKelanis').textContent = `Rp ${salesByArea['adamart kelanis'].toLocaleString('id-ID')}`;
            document.getElementById('transactionsKelanis').textContent = `${transByArea['adamart kelanis']} transaksi`;
        }
        
        function updateTopProducts() {
            const areas = ['adamart 73', 'adamart induksi', 'adamart kelanis'];
            areas.forEach(area => {
                const areaSales = filteredSales.filter(s => s.area === area);
                const productSales = {};
                areaSales.forEach(sale => {
                    if (sale.items) {
                        sale.items.split(',').forEach(item => {
                             const match = item.trim().match(/^(.+?)\s+x(\d+)$/);
                             if(match) {
                                 productSales[match[1].trim()] = (productSales[match[1].trim()] || 0) + parseInt(match[2]);
                             }
                        });
                    }
                });
                
                const sortedProducts = Object.entries(productSales).sort(([,a],[,b]) => b - a).slice(0, 3);
                
                const areaPart = area.split(' ')[1];
                const containerId = `topProducts${areaPart.charAt(0).toUpperCase() + areaPart.slice(1)}`;
                const container = document.getElementById(containerId);
                
                if (sortedProducts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Tidak ada data</p>';
                } else {
                    container.innerHTML = sortedProducts.map(([name, qty], i) => `
                        <div class="flex items-center justify-between p-2 bg-white rounded border-l-4 ${i === 0 ? 'border-yellow-400' : i === 1 ? 'border-gray-400' : 'border-orange-400'}">
                            <span class="text-sm font-medium">${name}</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded-full font-medium">${qty}</span>
                        </div>
                    `).join('');
                }
            });
        }
        
        function updateLowStockAlerts() {
            const areas = ['adamart 73', 'adamart induksi', 'adamart kelanis'];
            areas.forEach(area => {
                const stockKey = `Stok Area Kasir ${area}`;
                const lowStockProducts = allData.products.filter(p => (p[stockKey] || 0) < 10 && (p[stockKey] || 0) > 0);
                
                const areaPart = area.split(' ')[1];
                const containerId = `lowStock${areaPart.charAt(0).toUpperCase() + areaPart.slice(1)}`;
                const container = document.getElementById(containerId);
                
                if (lowStockProducts.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Semua stok aman ‚úÖ</p>';
                } else {
                     container.innerHTML = lowStockProducts.map(p => `
                        <div class="flex items-center justify-between bg-white p-2 rounded border-l-4 border-red-500">
                            <span class="text-sm font-medium">${p['Nama Produk']}</span>
                            <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-bold">${p[stockKey]}</span>
                        </div>
                    `).join('');
                }
            });
        }
        
        function updateTransactionHistory() {
            const tbody = document.getElementById('transactionHistory');
            const totalCount = filteredSales.length;
            const start = (currentPage - 1) * TRANSACTIONS_PER_PAGE;
            const end = start + TRANSACTIONS_PER_PAGE;
            const paginatedSales = filteredSales.slice(start, end);

            if (paginatedSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">Tidak ada data transaksi</td></tr>';
            } else {
                tbody.innerHTML = paginatedSales.map(sale => `
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="p-3">
                            <div class="text-sm font-medium">${sale.timestamp ? new Date(sale.timestamp).toLocaleDateString('id-ID') : '-'}</div>
                            <div class="text-xs text-gray-500">${sale.timestamp ? new Date(sale.timestamp).toLocaleTimeString('id-ID') : '-'}</div>
                        </td>
                        <td class="p-3">${sale.area || '-'}</td>
                        <td class="p-3"><div class="text-sm max-w-xs truncate" title="${sale.items || '-'}">${sale.items || '-'}</div></td>
                        <td class="p-3 font-medium">Rp ${(sale.total || 0).toLocaleString('id-ID')}</td>
                        <td class="p-3">${sale.method || '-'}</td>
                    </tr>
                `).join('');
            }
            
            document.getElementById('transactionCount').textContent = paginatedSales.length > 0 ? `${start + 1}-${Math.min(end, totalCount)}` : '0';
            document.getElementById('totalTransactionCount').textContent = totalCount;
            updatePaginationControls(totalCount);
        }
        
        function updatePaginationControls(totalCount) {
            const pageCount = Math.ceil(totalCount / TRANSACTIONS_PER_PAGE);
            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';
            
            const prevButton = document.createElement('button');
            prevButton.textContent = '‚Äπ';
            prevButton.className = 'px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => { if(currentPage > 1) { currentPage--; updateTransactionHistory(); } };
            controls.appendChild(prevButton);
            
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Hal ${currentPage} dari ${pageCount || 1}`;
            pageInfo.className = 'text-sm px-2';
            controls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = '‚Ä∫';
            nextButton.className = 'px-3 py-1 border rounded bg-white hover:bg-gray-100 disabled:opacity-50';
            nextButton.disabled = currentPage >= pageCount;
            nextButton.onclick = () => { if(currentPage < pageCount) { currentPage++; updateTransactionHistory(); } };
            controls.appendChild(nextButton);
        }

        function updateStockTable() {
            const tbody = document.getElementById('stockTable');
            const search = document.getElementById('stockSearch').value.toLowerCase();
            
            let products = allData.products;
            if(search) {
                products = products.filter(p => 
                    (p['Nama Produk'] && p['Nama Produk'].toLowerCase().includes(search)) ||
                    (p['Barcode'] && p['Barcode'].toLowerCase().includes(search))
                );
            }
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500">Tidak ada data stok</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => {
                const s73 = p['Stok Area Kasir adamart 73'] || 0;
                const sInduksi = p['Stok Area Kasir adamart induksi'] || 0;
                const sKelanis = p['Stok Area Kasir adamart kelanis'] || 0;
                const total = s73 + sInduksi + sKelanis;
                const isLow = total < 10;
                return `
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="p-3"><div class="font-medium">${p['Nama Produk']}</div><div class="text-xs text-gray-500">${p['Barcode']}</div></td>
                        <td class="p-3">Rp ${(p['Harga'] || 0).toLocaleString('id-ID')}</td>
                        <td class="p-3">${s73}</td>
                        <td class="p-3">${sInduksi}</td>
                        <td class="p-3">${sKelanis}</td>
                        <td class="p-3 font-bold">${total}</td>
                        <td class="p-3"><span class="px-2 py-1 ${isLow ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'} text-xs font-medium rounded-full">${isLow ? 'Menipis' : 'Aman'}</span></td>
                    </tr>
                `
            }).join('');
        }
        
        function updateDamageReports() {
            const tbody = document.getElementById('damageReports');
            if (!allData.reports || allData.reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">Tidak ada laporan</td></tr>';
                return;
            }

            tbody.innerHTML = allData.reports.map(r => {
                const product = allData.products.find(p => p['Barcode'] === r.barcode);
                const loss = product ? (product['Harga'] || 0) * (r.quantity || 0) : 0;
                return `
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="p-3">${new Date(r.timestamp).toLocaleString('id-ID')}</td>
                        <td class="p-3">${r.name}</td>
                        <td class="p-3">${r.quantity}</td>
                        <td class="p-3">${r.reason}</td>
                        <td class="p-3">${r.area}</td>
                        <td class="p-3 text-red-600 font-medium">Rp ${loss.toLocaleString('id-ID')}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function handleStockFormSubmit(e) {
            e.preventDefault();
            const formData = {
                barcode: document.getElementById('barcode').value.trim(),
                name: document.getElementById('productName').value.trim(),
                price: parseInt(document.getElementById('price').value) || 0,
                area: document.getElementById('targetArea').value,
                quantity: parseInt(document.getElementById('stockAmount').value) || 0
            };

            if (!formData.barcode || !formData.name || !formData.area || formData.quantity <= 0) {
                showError('Mohon lengkapi semua field dengan benar');
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({action: 'update_stock', data: formData})
                });
                const result = await response.json();
                if (result.success) {
                    showSuccess('Stok berhasil diupdate!');
                    this.reset();
                    loadManagerData();
                } else {
                    throw new Error(result.error || 'Gagal update stok');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showError('Gagal menambah stok. Periksa koneksi.');
            }
        }
        
        function exportTransactions() {
            if (filteredSales.length === 0) {
                showError('Tidak ada data untuk diekspor');
                return;
            }
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Waktu,Area,Items,Total,Metode\n"
                + filteredSales.map(s => `"${new Date(s.timestamp).toLocaleString('id-ID')}","${s.area}","${s.items.replace(/"/g, '""')}","${s.total}","${s.method}"`).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `adamart_transaksi_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshData() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('animate-spin');
            loadManagerData().finally(() => {
                icon.classList.remove('animate-spin');
            });
        }
        
        function showLoading(show, error = false) {
            document.getElementById('loadingState').classList.toggle('hidden', !show || error);
            document.getElementById('errorState').classList.toggle('hidden', !error);
            document.getElementById('dashboardContent').classList.toggle('hidden', show || error);
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            if(status === 'online') { el.innerHTML = 'üü¢ Online'; el.className = 'text-green-300'; }
            else if(status === 'offline') { el.innerHTML = 'üî¥ Offline'; el.className = 'text-red-300'; }
            else { el.innerHTML = 'üü° Connecting...'; el.className = 'text-yellow-300'; }
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = `Update: ${new Date().toLocaleTimeString('id-ID')}`;
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = document.getElementById('successToast');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const toast = document.getElementById('errorToast');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }
    </script>
</body>
</html>


